# 專案演進報告：從 Jupyter Notebook 到 Python 分析腳本

## 1. 引言

本報告旨在記錄 `datamining 2.ipynb` Jupyter Notebook 轉換並逐步完善為 `taoyuan_data_analysis.py` Python 腳本的過程。專案目標是分析桃園市各行政區的發展潛力，並將結果可視化。

## 2. 從 Notebook 到 Python 腳本

專案初期，相關的數據探索與分析在 `datamining 2.ipynb` 中進行。為了方便整合、調試及自動化執行，該 Notebook 的核心邏輯被轉換為獨立的 Python 腳本 `taoyuan_data_analysis.py`。

## 3. 主要解決的問題與程式碼變更

在將 Notebook 轉換為腳本並進行後續開發的過程中，遇到了多方面的挑戰。以下是主要的修改點和解決方案，這些變更體現在最終的 `taoyuan_data_analysis.py` 中：

### 3.1 資料載入與清理 (`load_and_process_data` 函數)

*   **統一區域名稱標準化**: 為了確保不同資料來源間可以正確合併，對所有 DataFrame 中的「區域別」欄位進行了標準化處理（例如，移除 "桃園市" 前綴，統一 "臺" 和 "台"，確保 "區" 字尾）。
*   **年齡與教育程度資料 (`df_ageedu`)**:
    *   處理了 ODS 檔案讀取時 `header` 位置不固定的問題。
    *   根據年齡段計算了15-64歲和65歲以上人口比例 (`pct_15_64`, `pct_65_up`)。
*   **現住人口資料 (`df_pop`)**:
    *   修正 ODS 檔案讀取 `header`。
    *   過濾了資料中的註腳行，確保只包含13個行政區的數據。
*   **商業登記資料 (`df_commerce`)**:
    *   處理了 CSV 檔案可能的 `UTF-8` 和 `Big5` 編碼問題。
    *   提取主行政區名稱。
    *   計算了各區的總商業登記家數 (`total_commercial`) 和香農多樣性指數 (`shannon_diversity`)。
*   **綜合所得資料 (`df_income_clean`)**:
    *   修改了邏輯，從原先可能處理村里級別的資料，改為精確提取財政部資料中各行政區「合計」行的「平均數」作為人均所得。
    *   處理了欄位名中的 BOM 字元 (如 `\ufeff縣市別`)。
    *   過濾了 "桃園市其他" 這類非目標行政區的資料。
*   **地理資訊資料 (`geojson_data`)**:
    *   修正了讀取 GeoJSON 時區域名稱屬性鍵的錯誤 (從 `'TOWNNAME'` 改為 `'名稱'`)。
    *   對 GeoJSON 中的區域名稱進行了與其他數據一致的標準化處理。

### 3.2 發展潛力標籤生成 (`generate_labels` 函數)

*   **放棄 KMeans 聚類**: 早期嘗試使用 KMeans 進行聚類，但因其產生的警告和結果解釋性問題，改為採用加權評分機制。
*   **加權評分與分組**:
    *   定義了各項指標的權重 (`feature_weights`)。
    *   計算各特徵的百分位排名。**關鍵修正**：統一了排名邏輯 (`rank(pct=True, ascending=True)` for all features)，確保「好的數值（例如高收入、高青壯年人口比例）」獲得更高的百分位排名，並由權重的正負號決定其對總分的貢獻方向（例如 `pct_65_up` 的權重為負，因此其較低的原始值對應較低的百分位排名，乘以負權重後懲罰較小，符合預期）。此前因排名方向邏輯混淆導致評分結果與直觀感受不符。
    *   基於加權總分 (`total_score`)，使用 `pd.qcut` 將行政區劃分為高、中、低三個發展潛力等級。
    *   解決了最初直接對原始數據點分組可能導致同一行政區出現在不同潛力組的問題，改為先按「區域別」計算平均得分再分組。

### 3.3 模型訓練與解釋 (`train_and_evaluate`, `explain_and_export` 函數)

*   取消了對模型訓練、評估和 SHAP 解釋函數調用的註釋。
*   確保了正確的特徵數據 (`X`) 和目標變數 (`y`) 傳遞給這些函數。
*   解決了 Matplotlib 中文字體顯示問題，確保決策樹圖和 SHAP 圖中的中文能正確顯示，方法是在腳本開頭設置 `plt.rcParams`。

### 3.4 地圖視覺化 (`build_map` 函數)

*   確保了合併到地圖數據中的各項指標在合併前區域名稱已正確標準化，避免了因名稱不匹配導致地圖全黑的問題。
*   移除了 `build_map` 函數中多餘的區域名稱修改邏輯，該邏輯會導致區域名稱格式錯誤。
*   確保 GeoJSON 中的區域名稱 (`feature.properties.名稱`) 與數據框中的 `區域別` 完全匹配。

### 3.5 其他修正

*   修正了 Pandas `groupby().apply().to_dict()` 操作產生的 `FutureWarning`，加入了 `observed=True`。
*   解決了腳本中多處因 `KeyError: '區域別'` 或 `NameError` 導致的程式中斷問題，主要通過確保「區域別」在 DataFrame 中作為欄位存在（而非僅索引），或調整變數定義的範圍。

## 4. 分析結果視覺化

以下圖像展示了分析的主要成果：

### 4.1 桃園市行政區發展潛力地圖

![桃園市行政區發展潛力地圖](image.png)
*圖註：此地圖顯示了桃園市各行政區根據綜合指標評估的發展潛力分級。*

### 4.2 決策樹模型

![決策樹模型](output/decision_tree.png)
*圖註：此決策樹模型基於各項特徵對發展潛力等級進行分類。*

### 4.3 SHAP 特徵重要性摘要圖

![SHAP 特徵重要性摘要圖](output/shap_summary.png)
*圖註：此 SHAP 圖顯示了不同特徵對模型預測結果的影響方向與大小。*

## 5. 結論

經過一系列的調試與邏輯修正，`taoyuan_data_analysis.py` 腳本現在能夠穩定運行，並產出更為合理且符合直覺的桃園市各行政區發展潛力分析結果。資料處理流程更加穩健，視覺化輸出清晰。 